<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Home • Relm</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  </head>

  <body class="min-h-screen bg-zinc-900 text-white">
    <main class="max-w-5xl mx-auto px-4 md:px-6 py-8 grid grid-cols-1 md:grid-cols-3 gap-6">
      

      <!-- Feed (left/middle, spans 2 cols on desktop) -->
      <section class="md:col-span-2 space-y-6">

        <!-- Top bar -->
        <div class="flex items-center justify-between mb-2">
            <a href="/home" class="text-2xl font-semibold tracking-tight inline-block mb-4">
              <span class="text-blue-400">R</span>elm
            </a>
          <div class="flex items-center gap-3">
            <% if (user) { %>
              <a href="/profile" class="text-sm px-3 py-2 rounded-lg border border-zinc-700 hover:bg-zinc-800">
                Profile
              </a>
              <a href="/posts/new" class="text-sm px-3 py-2 rounded-lg bg-gradient-to-r from-blue-600 to-indigo-600">
                New post
              </a>
            <% } else { %>
              <a href="/auth/signin" class="text-sm px-3 py-2 rounded-lg border border-zinc-700 hover:bg-zinc-800">
                Sign in
              </a>
            <% } %>
          </div>
        </div>

        <!-- Quick compose (small) -->
        <% if (user) { %>
          <div class="bg-zinc-800/60 p-4 rounded-xl">
            <form action="/posts" method="POST" class="flex gap-3 items-start">
              <img src="<%= user.image %>" alt="avatar" class="w-10 h-10 rounded-full object-cover bg-zinc-700" />
              <div class="flex-1">
                <input name="title" placeholder="Write a title" class="w-full px-3 py-2 rounded-lg bg-zinc-900/40 border border-zinc-700 placeholder-zinc-400" />
                <textarea name="content" rows="3" placeholder="Share something with the community" class="w-full mt-2 px-3 py-2 rounded-lg bg-zinc-900/40 border border-zinc-700 placeholder-zinc-400 resize-none"></textarea>
                <div class="flex items-center justify-between mt-2">
                  <div class="text-xs text-zinc-500">All posts are public</div>
                  <div>
                    <button type="submit" class="px-3 py-1 rounded-lg bg-gradient-to-r from-blue-600 to-indigo-600 text-sm">Publish</button>
                  </div>
                </div>
              </div>
            </form>
          </div>
        <% } %>

        <!-- Feed list -->
        <div class="space-y-4">
          <% if (posts && posts.length) { %>
            <% for (var i = 0; i < posts.length; i++) {
                 var post = posts[i];
                 var preview = post.content ? String(post.content) : '';
                 var snippet = preview.length > 220 ? preview.substring(0, 220) + '...' : preview;
            %>
              <article class="p-5 rounded-xl bg-zinc-800/60 hover:bg-zinc-800 transition">
                <div class="flex items-start gap-4">
                  <img src="<%= (post.author && post.author.image) ? post.author.image : 'default-avatar.png' %>" alt="author" class="w-12 h-12 rounded-full object-cover bg-zinc-700" />

                  <div class="flex-1">
                    <div class="flex items-start justify-between">
                      <div>
                        <div class="text-sm font-medium text-zinc-100">
                          <%= (post.author && (post.author.name || post.author.username)) ? (post.author.name || post.author.username) : 'Author' %>
                        </div>
                        <div class="text-xs text-zinc-400">@<%= (post.author && post.author.username) ? post.author.username : 'unknown' %></div>
                      </div>

                      <div class="text-xs text-zinc-500">
                  <%= dayjs(post.createdAt).format("DD MMM • HH:mm") %>
                      </div>
                    </div>

                    <a href="/posts/<%= post._id %>" class="block mt-3">
                      <h2 class="text-lg font-semibold text-zinc-100 mb-1"><%= post.title %></h2>
                      <p class="text-sm text-zinc-400 whitespace-pre-line"><%= snippet %></p>
                    </a>

                    <div class="mt-4 flex items-center justify-between text-xs text-zinc-500">
                      <div class="flex items-center gap-3">
                        <button
                          class="like-btn flex items-center gap-2 px-2 py-1 rounded-lg hover:bg-zinc-700"
                          data-post-id="<%= post._id %>"
                          data-liked="<%= (user && Array.isArray(post.likes) && post.likes.some(function(l){ return String(l._id || l) === String(user._id); })) ? 'true' : 'false' %>"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 12v6a2 2 0 002 2h12a2 2 0 002-2v-6M7 12l3-7 3 7 3-7 3 7" />
                          </svg>
                          <span class="like-count"><%= Array.isArray(post.likes) ? post.likes.length : 0 %></span>
                          <span class="like-text text-zinc-300 text-xs"><%= (user && Array.isArray(post.likes) && post.likes.some(function(l){ return String(l._id || l) === String(user._id); })) ? 'Liked' : 'Like' %></span>
                        </button>

                        <a href="/posts/<%= post._id %>" class="text-zinc-400 hover:text-white">Read</a>
                      </div>

                      <div class="text-xs text-zinc-400"><%= Array.isArray(post.likes) ? post.likes.length : 0 %> likes</div>
                    </div>
                  </div>
                </div>
              </article>
            <% } %>
          <% } else { %>
            <div class="text-sm text-zinc-500 p-6 rounded-lg bg-zinc-800/40">No posts yet. Be the first to post.</div>
          <% } %>
        </div>
      </section>

      <!-- Sidebar (right) -->
      <aside class="hidden md:block">
        <div class="sticky top-6 space-y-4">

          <% if (user) { %>
            <!-- Profile card -->
            <div class="bg-zinc-800/60 p-4 rounded-xl text-sm">
              <div class="flex items-center gap-3">
                <img src="<%= user.image %>" alt="you" class="w-14 h-14 rounded-full object-cover bg-zinc-700" />
                <div>
                  <div class="text-sm font-medium text-zinc-100"><%= user.name || user.username %></div>
                  <div class="text-xs text-zinc-400">@<%= user.username %></div>
                </div>
              </div>

              <p class="text-xs text-zinc-300 mt-3 leading-6"><%= user.bio || 'No bio yet.' %></p>

              <div class="mt-3 flex gap-2">
                <a href="/profile" class="flex-1 px-3 py-1 text-center rounded-lg border border-zinc-700 text-sm hover:bg-zinc-800">View profile</a>
              </div>
            </div>
          <% } else { %>
            <!-- Sign-in card for guests -->
            <div class="bg-zinc-800/60 p-4 rounded-xl text-sm text-center">
              <div class="font-medium text-zinc-100 mb-2">Welcome</div>
              <div class="text-xs text-zinc-300 mb-4">Sign in to create posts and like content</div>
              <a href="/auth/signin" class="px-3 py-1 rounded-lg border border-zinc-700 hover:bg-zinc-800">Sign in</a>
            </div>
          <% } %>

          <!-- Tips (simple) -->
          <div class="bg-zinc-800/60 p-4 rounded-xl text-sm text-zinc-300">
            <div class="font-medium text-zinc-100 mb-2">Tips</div>
            <div class="text-xs">Write clear titles, keep posts short for more reads.</div>
          </div>

        </div>
      </aside>
    </main>

    <script>
      (function () {
        document.addEventListener('click', async function (e) {
          const btn = e.target.closest('.like-btn');
          if (!btn) return;

          // If no user on page, do nothing (server will block but better UX to stop)

          const postId = btn.dataset.postId;
          const likedNow = btn.dataset.liked === 'true';
          const countEl = btn.querySelector('.like-count');
          const textEl = btn.querySelector('.like-text');

          let count = parseInt(countEl.textContent, 10) || 0;

          // optimistic
          if (likedNow) {
            count = Math.max(0, count - 1);
            btn.dataset.liked = 'false';
            if (textEl) textEl.textContent = 'Like';
          } else {
            count = count + 1;
            btn.dataset.liked = 'true';
            if (textEl) textEl.textContent = 'Liked';
          }
          if (countEl) countEl.textContent = count;

          try {
            const res = await fetch('/posts/' + postId + '/like', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({})
            });

            if (!res.ok) throw new Error('Network');

            const data = await res.json();
            if (data && typeof data.likesCount === 'number') {
              if (countEl) countEl.textContent = data.likesCount;
              btn.dataset.liked = data.liked ? 'true' : 'false';
              if (textEl) textEl.textContent = data.liked ? 'Liked' : 'Like';
            }
          } catch (err) {
            // revert on error
            if (likedNow) {
              btn.dataset.liked = 'true';
              if (textEl) textEl.textContent = 'Liked';
              if (countEl) countEl.textContent = (parseInt(countEl.textContent,10)||0) + 1;
            } else {
              btn.dataset.liked = 'false';
              if (textEl) textEl.textContent = 'Like';
              if (countEl) countEl.textContent = Math.max(0, (parseInt(countEl.textContent,10)||0) - 1);
            }
          }
        });
      })();
    </script>
  </body>
</html>
