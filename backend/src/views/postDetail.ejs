<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>
      <%= post.title %> • Relm
    </title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="/style.css" />
  </head>

  <body class="min-h-screen bg-zinc-900 text-white">
    <main class="max-w-3xl mx-auto px-6 py-10">
      <a href="/home" class="text-2xl font-semibold tracking-tight inline-block mb-4">
        <span class="text-blue-400">R</span>elm
      </a>
      <!-- Back -->
      <div class="mb-6">
        <a href="/profile" class="text-sm text-zinc-400 hover:text-white"
          >← Back to profile</a
        >
      </div>

      <!-- Post header -->
      <article class="bg-zinc-800/60 p-6 rounded-2xl shadow-sm">
        <header class="mb-6">
          <h1 class="text-2xl font-semibold tracking-tight mb-3">
            <%= post.title %>
          </h1>

          <div class="flex items-center justify-between gap-4">
            <div class="flex items-center gap-3">
              <img
                src="<%= post.author && post.author.image %>"
                alt="author avatar"
                class="w-12 h-12 rounded-full object-cover bg-zinc-700"
              />
              <div class="text-sm">
                <div class="font-medium">
                  <% if (post.author && post.author._id &&
                  String(post.author._id) === String(user._id)) { %> You <% }
                  else { %> <%= post.author.name || post.author.username ||
                  'Author' %> <% } %>
                </div>
                <div class="text-zinc-400 text-xs">
                  <%= dayjs(post.createdAt).format("DD MMM • HH:mm") %>
                </div>
              </div>
            </div>

            <div class="flex items-center gap-2">
              <% /* Show edit if current user is the author */ %> <% if
              (post.author && post.author._id && String(post.author._id) ===
              String(user._id)) { %>
              <a
                href="/posts/<%= post._id %>/edit"
                class="px-3 py-1 text-sm rounded-lg border border-zinc-700 hover:bg-zinc-800"
              >
                Edit
              </a>
              <% } %> <% const hasLiked = post.likes.some(a => a._id.toString()
              === user._id.toString()); %>
              <button
                class="like-button px-3 py-1 rounded-lg <%= hasLiked ? 'bg-red-300' : 'bg-zinc-700/50' %> text-sm flex items-center gap-2 cursor-pointer"
                data-post-id="<%= post._id %>"
              >
                ❤️
                <span class="like-count"><%= post.likes.length %></span>
                <span class="text-xs text-zinc-300">Like</span>
              </button>
            </div>
          </div>
        </header>

        <!-- Post body -->
        <section class="prose max-w-none text-sm text-zinc-100">
          <div class="leading-7 text-zinc-100 whitespace-pre-line"><%= post.content %></div>
        </section>

        <!-- Footer meta -->
        <footer
          class="mt-6 text-xs text-zinc-500 flex items-center justify-between"
        >
          <div>
            <span>Author: </span>
            <span class="text-zinc-200"
              ><%= post.author.username || post.author.name || 'Author' %></span
            >
          </div>

          <div>
            <span>Views: </span>
            <span class="text-zinc-200">—</span>
          </div>
        </footer>
      </article>
      <!-- Comments -->
      <section class="mt-10">
        <div class="bg-zinc-800/60 rounded-2xl p-6 space-y-6">

          <!-- Header -->
          <div class="flex items-center justify-between">
            <h2 class="text-sm font-semibold tracking-tight">
              Comments
              <span class="text-zinc-400 font-normal">
                (<%= post.comments.length %>)
              </span>
            </h2>
          </div>
          <!-- Add comment -->
          <form
            id="comment-form"
            action="/posts/<%= post._id %>/comments"
            method="post"
            class="space-y-3"
          >
            <textarea
              name="content"
              rows="2"
              placeholder="Write a thoughtful comment…"
              class="w-full resize-none rounded-xl bg-zinc-900 border border-zinc-700 px-4 py-2 text-sm text-zinc-100 placeholder-zinc-500 focus:outline-none focus:border-blue-400"
              required
            ></textarea>

            <div class="flex justify-end">
              <button
                type="submit"
                class="px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-sm font-medium transition"
              >
                Post comment
              </button>
            </div>
          </form>

          <!-- Divider -->
          <div class="h-px bg-zinc-700/60"></div>

          <!-- Comment list -->
          <div id="comments" class="space-y-5">

            <% if (post.comments.length === 0) { %>
              <p class="text-sm text-zinc-400 text-center py-6">
                No comments yet. Be the first to share your thoughts.
              </p>
            <% } %>

            <% post.comments.forEach(comment => { %>
              <div class="flex gap-4">

                <!-- Avatar -->
                <img
                  src="<%= comment.author.image %>"
                  alt="avatar"
                  class="w-10 h-10 rounded-full object-cover bg-zinc-700 flex-shrink-0"
                />

                <!-- Comment bubble -->
                <div class="flex-1 bg-zinc-900/70 rounded-xl px-4 py-3">

                  <div class="flex items-center justify-between">
                    <span class="text-sm font-medium">
                      <%= comment.author.username || comment.author.name %>
                    </span>
                    <div class="flex flex gap-2 items-center" >
                     <span class="text-xs text-zinc-400">
                      <%= dayjs(comment.createdAt).format("DD MMM • HH:mm") %>
                     </span>
                    <% if (user._id.toString() === comment.author._id.toString()) { %>
                      <span class="text-xs text-zinc-400 hover:text-red-400 transition" >
                        <a href="/posts/<%= post._id %>/comments/<%= comment._id %>/delete">Delete</a>
                      </span>
                    <% } %>
                    </div>
                  </div>

                  <p class="mt-1 text-sm text-zinc-100 leading-relaxed">
                    <%= comment.content %>
                  </p>

                </div>
              </div>
            <% }) %>

          </div>

        </div>
      </section>


    </main>
    <script>
      const button = document.querySelector(".like-button");
      button.addEventListener("click", async () => {
        const postId = button.dataset.postId;

        const res = await fetch(`/posts/${postId}/like`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        });

        const data = await res.json();

        const countEl = button.querySelector(".like-count");
        countEl.textContent = data.likesCount;

        if (data.liked) {
          button.classList.remove("bg-zinc-700/50");
          button.classList.add("bg-red-300");
        } else {
          button.classList.remove("bg-red-300");
          button.classList.add("bg-zinc-700/50");
        }
      });
    </script>
  </body>
</html>
